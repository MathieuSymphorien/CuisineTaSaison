name: CI/CD Pipeline

on:
  push:
    branches:
      - main

# Empêche 2 déploiements en parallèle
concurrency:
  group: production
  cancel-in-progress: false

jobs:

  # ──────────────────────────────────────────
  # Job 1 : Build de vérification
  # ──────────────────────────────────────────
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Backend ---
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Build backend
        working-directory: ./back/cts
        run: |
          chmod +x mvnw
          ./mvnw package -DskipTests -B

      # --- Frontend ---
      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build frontend
        working-directory: ./front
        run: |
          npm install
          npm run build -- --configuration=production

  # ──────────────────────────────────────────
  # Job 2 : Tests (prêt pour quand tu en auras)
  # ──────────────────────────────────────────
  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Tests Backend ---
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Run backend tests
        working-directory: ./back/cts
        run: |
          chmod +x mvnw
          ./mvnw test -B
        continue-on-error: true

      # --- Tests Frontend ---
      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Run frontend tests
        working-directory: ./front
        run: |
          npm install
          npm test -- --watch=false --browsers=ChromeHeadless
        continue-on-error: true

  # ──────────────────────────────────────────
  # Job 3 : Versioning + Release GitHub
  # ──────────────────────────────────────────
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: write
    outputs:
      new_version: ${{ steps.version.outputs.new_tag }}
      changelog: ${{ steps.version.outputs.changelog }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version and create tag
        id: version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch
          tag_prefix: v

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.version.outputs.new_tag }}
          name: Release ${{ steps.version.outputs.new_tag }}
          body: |
            ## What's Changed

            ${{ steps.version.outputs.changelog }}

            ---
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.version.outputs.previous_tag }}...${{ steps.version.outputs.new_tag }}
          token: ${{ secrets.GITHUB_TOKEN }}

  # ──────────────────────────────────────────
  # Job 4 : Déploiement sur le serveur
  # ──────────────────────────────────────────
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: release
    environment: production

    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 49155
          script: |
            set -e

            cd /opt/CuisineTaSaison

            PREVIOUS_COMMIT=$(git rev-parse HEAD)

            git pull origin main

            cat > .env << EOF
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}
            ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            POSTGRES_DB=${{ secrets.POSTGRES_DB }}
            EOF

            if ! docker compose -f docker-compose.prod.yml build --no-cache; then
              echo "Build failed, rolling back..."
              git checkout $PREVIOUS_COMMIT
              exit 1
            fi

            docker compose -f docker-compose.prod.yml up -d

            echo "Waiting for health check..."
            sleep 10

            if ! docker compose -f docker-compose.prod.yml ps | grep -q "Up"; then
              echo "Containers not running, rolling back..."
              git checkout $PREVIOUS_COMMIT
              docker compose -f docker-compose.prod.yml up -d
              exit 1
            fi

            docker image prune -f

            echo "Deployed version ${{ needs.release.outputs.new_version }}"
